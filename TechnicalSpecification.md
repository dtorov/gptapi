# Техническое задание на разработку системы предоставления доступа к API ChatGPT через собственный REST API сервер

## Введение

Данный документ описывает технические требования для разработки системы предоставления доступа к API ChatGPT через собственные REST API сервер. Система будет включать серверную часть, реализованную на Node.js с использованием фреймворка Express и запущенную в контейнерах Docker, а также клиентские приложения: чат-бот в Telegram на платформе botboom.ru и веб-интерфейс на Vue3 и Bootstrap5. Система должна обеспечивать передачу запросов к API ChatGPT, сохранение контекста по пользователям, ведение биллинга запросов и оплату токенов.

## Общие требования

1. **Язык разработки**: JavaScript/TypeScript.
2. **Фреймворк**: Express.js.
3. **Контейнеризация**: Docker.
4. **Клиенты**:
   - Чат-бот в Telegram на платформе botboom.ru.
   - Веб-интерфейс на Vue3 и Bootstrap5.
   - Сервис https://1cmaker.com/
5. **База данных**: MongoDB для хранения данных пользователей, контекста и биллинга.
6. **Аутентификация и авторизация**: JWT.
7. **Документация API**: Swagger/OpenAPI.
8. **Панель администрирования**: Для управления пользователями, балансом и просмотра диалогов.

## Функциональные требования

### 1. API для работы с ChatGPT

#### 1.1. Обработка запросов

- **Метод**: `POST /api/chat`
- **Описание**: Передача запроса к API ChatGPT.
- **Параметры запроса**:
  - `userId` (string): Идентификатор пользователя.
  - `message` (string): Сообщение пользователя.
  - `context` (array, optional): Контекст предыдущих сообщений.
- **Ответ**:
  - `message` (string): Ответ от ChatGPT.
  - `context` (array): Обновленный контекст.
  - `tokensUsed` (number): Количество использованных токенов.
- **Ошибки**:
  - `400 Bad Request`: Неверные параметры запроса (например, отсутствует `userId` или `message`).
  - `401 Unauthorized`: Неверный или отсутствующий токен аутентификации.
  - `402 Payment Required`: Недостаточно токенов для выполнения запроса.
  - `500 Internal Server Error`: Ошибка на стороне сервера при обработке запроса к API ChatGPT.

### 2. Сохранение контекста

#### 2.1. Сохранение контекста сообщений

- **Метод**: `POST /api/context`
- **Описание**: Сохранение контекста сообщений пользователя.
- **Параметры запроса**:
  - `userId` (string): Идентификатор пользователя.
  - `context` (array): Контекст сообщений.
- **Ответ**:
  - `success` (boolean): Результат операции.
- **Ошибки**:
  - `400 Bad Request`: Неверные параметры запроса (например, отсутствует `userId` или `context`).
  - `401 Unauthorized`: Неверный или отсутствующий токен аутентификации.
  - `500 Internal Server Error`: Ошибка на стороне сервера при сохранении контекста.

#### 2.2. Получение контекста

- **Метод**: `GET /api/context`
- **Описание**: Получение сохраненного контекста пользователя.
- **Параметры запроса**:
  - `userId` (string): Идентификатор пользователя.
- **Ответ**:
  - `context` (array): Сохраненный контекст.
- **Ошибки**:
  - `400 Bad Request`: Неверные параметры запроса (например, отсутствует `userId`).
  - `401 Unauthorized`: Неверный или отсутствующий токен аутентификации.
  - `404 Not Found`: Контекст для указанного `userId` не найден.
  - `500 Internal Server Error`: Ошибка на стороне сервера при получении контекста.

#### 2.3. Сброс контекста

- **Метод**: `POST /api/context/reset`
- **Описание**: Сброс контекста сообщений пользователя.
- **Параметры запроса**:
  - `userId` (string): Идентификатор пользователя.
- **Ответ**:
  - `success` (boolean): Результат операции.
- **Ошибки**:
  - `400 Bad Request`: Неверные параметры запроса (например, отсутствует `userId`).
  - `401 Unauthorized`: Неверный или отсутствующий токен аутентификации.
  - `500 Internal Server Error`: Ошибка на стороне сервера при сбросе контекста.

### 3. Биллинг и оплата токенов

#### 3.1. Ведение биллинга

- **Метод**: `GET /api/billing`
- **Описание**: Получение информации о биллинге пользователя.
- **Параметры запроса**:
  - `userId` (string): Идентификатор пользователя.
- **Ответ**:
  - `totalTokens` (number): Общее количество использованных токенов.
  - `currentBalance` (number): Текущий баланс пользователя.
- **Ошибки**:
  - `400 Bad Request`: Неверные параметры запроса (например, отсутствует `userId`).
  - `401 Unauthorized`: Неверный или отсутствующий токен аутентификации.
  - `500 Internal Server Error`: Ошибка на стороне сервера при получении данных биллинга.

#### 3.2. Пополнение баланса

- **Метод**: `POST /api/billing/topup`
- **Описание**: Пополнение баланса пользователя.
- **Параметры запроса**:
  - `userId` (string): Идентификатор пользователя.
  - `amount` (number): Сумма пополнения.
- **Ответ**:
  - `success` (boolean): Результат операции.
  - `currentBalance` (number): Текущий баланс пользователя.
- **Ошибки**:
  - `400 Bad Request`: Неверные параметры запроса (например, отсутствует `userId` или `amount`).
  - `401 Unauthorized`: Неверный или отсутствующий токен аутентификации.
  - `500 Internal Server Error`: Ошибка на стороне сервера при пополнении баланса.

### 4. Аутентификация и авторизация

#### 4.1. Регистрация пользователя

- **Метод**: `POST /api/auth/register`
- **Описание**: Регистрация нового пользователя.
- **Параметры запроса**:
  - `username` (string): Имя пользователя.
  - `password` (string): Пароль пользователя.
- **Ответ**:
  - `userId` (string): Идентификатор пользователя.
  - `token` (string): JWT токен.
- **Ошибки**:
  - `400 Bad Request`: Неверные параметры запроса (например, отсутствует `username` или `password`).
  - `409 Conflict`: Пользователь с таким именем уже существует.
  - `500 Internal Server Error`: Ошибка на стороне сервера при регистрации пользователя.

#### 4.2. Вход пользователя

- **Метод**: `POST /api/auth/login`
- **Описание**: Аутентификация пользователя.
- **Параметры запроса**:
  - `username` (string): Имя пользователя.
  - `password` (string): Пароль пользователя.
- **Ответ**:
  - `token` (string): JWT токен.
- **Ошибки**:
  - `400 Bad Request`: Неверные параметры запроса (например, отсутствует `username` или `password`).
  - `401 Unauthorized`: Неверное имя пользователя или пароль.
  - `500 Internal Server Error`: Ошибка на стороне сервера при аутентификации пользователя.

### 5. Панель администрирования

#### 5.1. Управление пользователями

- **Метод**: `GET /api/admin/users`
- **Описание**: Получение списка всех пользователей.
- **Параметры запроса**: Отсутствуют.
- **Ответ**:
  - `users` (array): Список пользователей.
- **Ошибки**:
  - `401 Unauthorized`: Неверный или отсутствующий токен аутентификации.
  - `403 Forbidden`: Недостаточно прав для доступа.
  - `500 Internal Server Error`: Ошибка на стороне сервера при получении списка пользователей.

#### 5.2. Изменение баланса пользователя

- **Метод**: `POST /api/admin/user/:userId/balance`
- **Описание**: Изменение баланса пользователя.
- **Параметры запроса**:
  - `amount` (number): Новое значение баланса.
- **Ответ**:
  - `success` (boolean): Результат операции.
- **Ошибки**:
  - `400 Bad Request`: Неверные параметры запроса (например, отсутствует `amount`).
  - `401 Unauthorized`: Неверный или отсутствующий токен аутентификации.
  - `403 Forbidden`: Недостаточно

 прав для доступа.
  - `500 Internal Server Error`: Ошибка на стороне сервера при изменении баланса пользователя.

#### 5.3. Просмотр диалогов пользователей

- **Метод**: `GET /api/admin/user/:userId/dialogs`
- **Описание**: Получение всех диалогов пользователя.
- **Параметры запроса**: Отсутствуют.
- **Ответ**:
  - `dialogs` (array): Список диалогов пользователя.
- **Ошибки**:
  - `401 Unauthorized`: Неверный или отсутствующий токен аутентификации.
  - `403 Forbidden`: Недостаточно прав для доступа.
  - `500 Internal Server Error`: Ошибка на стороне сервера при получении диалогов пользователя.

## Нефункциональные требования

1. **Производительность**: Система должна обрабатывать до 1000 запросов в секунду.
2. **Масштабируемость**: Возможность горизонтального масштабирования через Docker Swarm или Kubernetes.
3. **Безопасность**: Использование HTTPS для всех запросов, защита данных пользователей.
4. **Логирование и мониторинг**: Интеграция с системами логирования (например, ELK stack) и мониторинга (например, Prometheus, Grafana).

### Параметры для мониторинга в Grafana

- **Запросы в секунду**: Количество запросов, обрабатываемых сервером в секунду.
- **Среднее время отклика**: Время, затрачиваемое на обработку запроса.
- **Ошибки по типам**: Количество ошибок, сгруппированных по типам (400, 401, 402, 403, 404, 500).
- **Загрузка процессора**: Уровень загрузки CPU на сервере.
- **Использование памяти**: Объем используемой оперативной памяти.
- **Число активных пользователей**: Количество пользователей, взаимодействующих с системой в данный момент.
- **Средний размер ответа**: Средний размер данных, возвращаемых сервером.
- **Использование токенов**: Общее количество использованных токенов за определенный период.
- **Баланс пользователей**: Средний и медианный баланс пользователей.

## Архитектура системы

### Серверная часть

1. **Express.js**: Основной фреймворк для создания REST API.
2. **JWT**: Для аутентификации и авторизации.
3. **MongoDB**: Для хранения данных пользователей, контекста и биллинга.
4. **Docker**: Для контейнеризации и деплоя приложения.

### Клиентская часть

1. **Telegram бот**: Реализован на платформе botboom.ru, взаимодействует с REST API сервера, предоставляет доступ к тексовому диалогу с ChatGPT.
2. **Веб-интерфейс**: Разработан на Vue3 и Bootstrap5 для управления учетной записью пользователя и биллингом.
1. **Сервис https://1cmaker.com/**: Взаимодействует с REST API сервера, предоставляет доступ к тексовому диалогу с ChatGPT.

### Панель администрирования

1. **Админ-интерфейс**: Разработан на Vue3 и Bootstrap5 для управления пользователями, их балансом и просмотра диалогов.

## Взаимодействие компонентов

1. Клиент (Telegram бот, веб-интерфейс, 1cmaker) отправляет запросы к REST API серверу.
2. REST API сервер обрабатывает запросы, взаимодействует с API ChatGPT, сохраняет контекст и обновляет биллинг.
3. Панель администрирования позволяет администраторам управлять пользователями и просматривать их взаимодействия.
4. Сервер отвечает клиенту, передавая необходимую информацию (ответ от ChatGPT, обновленный контекст, данные биллинга и т.д.).

## Документация

1. **Swagger/OpenAPI**: Для документирования всех доступных API эндпоинтов.
2. **README**: Основная информация о проекте, инструкции по установке и запуску.

## Заключение

Данное техническое задание охватывает основные требования для разработки системы предоставления доступа к API ChatGPT через собственный REST API сервер. Реализация данной системы позволит эффективно обрабатывать запросы пользователей, сохранять контекст общения, управлять биллингом токенов и обеспечивать административный контроль над пользователями и их взаимодействиями.
